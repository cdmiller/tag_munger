#!/usr/bin/env ruby

############################
# tag_utility.rb
# A small utility which will let you display album and track 
# tag information from mp3 files and will allow you to apply
# our album name generator for mp3 files in the "tape library"
# 

require 'optparse'
require_relative '../lib/tag_munger' #the class that handles our munging

VERSION="version 0.0.1"

options = {}
# defaults
options[:directory] = "."
options[:dry_run] = true

# check the command line options
if ARGV.count == 0 #print help text if no options supplied
  ARGV << "--help"
end

OptionParser.new do |opts|
  opts.banner = "\nUsage: tag_utility [options] \n\t\t***tag_utility defaults to dry_run/report mode***\n\t\t***Use --write-changes option to actually change tags***"
  opts.version = VERSION

  opts.on("-b [FLAGS]","--browse [FLAGS]",\
          "Display the current mp3 metadata of files in the directory specified by -d."\
          "\n\t\t\t\t\tTakes optional, comma separated list of tags you're interested in (album,artist,track)") do |flags|
    options[:browse] = flags || true
  end

  opts.on("-a","--albums", "Derive new album tag for mp3 files and output them to the screen."\
          "\n\t\t\t\t\tYou need to specify the write-changes option to actually change the album tags.") do |a|
    # runs the generic album name generator. Does a dry run by default
    options[:albums] = a
  end

  opts.on("--write-changes", "Changes the tags in the files (takes you out of dry run mode)\n\n") do |w|
    options[:dry_run] = false
  end
  
  opts.on("-d LIBRARY_ROOT","--directory LIBRARY_ROOT", "Where to find the mp3 files") do |library_root|
    options[:directory] = library_root
  end

  opts.on("-e FILENAME", "--edit FILENAME", "Interactive editing of tags for given file. Accepts limited globbing on filename.") do |file_name|
    options[:edit] = file_name
  end
  opts.on("-t","--tapeLib", "Use this option to set the album tag and track title tag for use in the international tape library."\
          "\n\t\t\t\t\tOutput them to the screen. You need to specify the write-changes option to actually change the tags.") do |a|
    # runs the international fix album function. Does a dry run by default
    options[:tape_lib] = a
  end
  
end.parse!

# create a new tag munger object to access the tags
tagger = TagMunger.new(options[:directory], options[:dry_run])

# do stuff

if options.has_key?(:browse)
  puts options[:browse]
  if options[:browse].class == String
    which_tags =  options[:browse].split(",")
  end
  tagger.browseLibrary(which_tags)
end

if options.has_key?(:albums)
  tagger.fix_album_tags
end

if options.has_key?(:tape_lib)
  tagger.international_fix_album_tags
end

if options.has_key?(:edit)
  puts "--edit option was specified with filename: #{options[:edit]}"
  tagger.interactive_edit(options[:edit])
end
